<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <title>RU-SAFE</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg: #07090d;
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --low:  #44c2ff;   /* 1–2 */
      --med:  #ffcc33;   /* 3 */
      --high: #ff7a18;   /* 4 */
      --crit: #ff3344;   /* 5 */

      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 18px;
      --blur: 16px;

      --topPad: env(safe-area-inset-top);
      --botPad: env(safe-area-inset-bottom);
    }

    *{ box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    #app { height: 100%; width: 100%; position: relative; overflow: hidden; }
    #map { height: 100%; width: 100%; }

    input, select { font-size: 16px; }

    .topbar{
      position: absolute;
      left: 12px; right: 12px;
      top: calc(12px + var(--topPad));
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 1000;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,17,24,.82), rgba(15,17,24,.62));
      backdrop-filter: blur(var(--blur));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 190px;
      flex: 0 0 auto;
    }

    /* RU-SAFE logo */
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
      background: rgba(255,255,255,.04);
    }
    .logo svg{ display:block; }

    /* CAPS */
    .brand h1{
      font-size: 14px;
      margin: 0;
      line-height: 1.1;
      letter-spacing: .9px;
      text-transform: uppercase;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: .55px;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,17,24,.82), rgba(15,17,24,.62));
      backdrop-filter: blur(var(--blur));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .pill small{ color: var(--muted); }

    .btn{
      cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      transition: transform .08s ease, background .2s ease;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(.98); }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn svg{ width: 16px; height: 16px; opacity: .9; }

    .btn.primary{
      background: rgba(68,194,255,.14);
      border-color: rgba(68,194,255,.35);
    }
    .btn.warn{
      background: rgba(255,122,24,.12);
      border-color: rgba(255,122,24,.35);
    }
    .btn.danger{
      background: rgba(255,51,68,.12);
      border-color: rgba(255,51,68,.35);
    }
    .btn.tiny{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .btn.active{
      outline: 2px solid rgba(68,194,255,.28);
    }

    .sheet{
      position:absolute;
      left: 12px; right: 12px;
      bottom: calc(12px + var(--botPad));
      z-index: 1000;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,17,24,.92), rgba(15,17,24,.70));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow: hidden;

      transform: translateY(var(--sheetY, 0px));
      transition: transform .22s ease;
    }
    .sheetHeader{
      display:flex; align-items:center; justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      gap: 10px;
      touch-action: none;
    }
    .grab{ width: 42px; height: 5px; border-radius: 999px; background: rgba(255,255,255,.22); margin: 0 auto 8px; }
    .sheetTitle{ display:flex; flex-direction: column; gap: 2px; }
    .sheetTitle b{ font-size: 13px; }
    .sheetTitle span{ font-size: 12px; color: var(--muted); }

    .sheetBody{ padding: 12px 14px 14px; display: grid; gap: 12px; }
    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content: space-between; }
    .control{ display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

    select, input[type="number"]{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 14px;
      outline: none;
      min-width: 160px;
    }
    select option{ background: #0e1118; color: var(--text); }

    .legend{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; font-size: 12px; color: var(--muted); }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .dot{ width: 10px; height: 10px; border-radius: 999px; box-shadow: 0 0 0 4px rgba(255,255,255,.06); }
    .tip{ font-size: 12px; color: var(--muted); line-height: 1.35; }

    .sectionTitle{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      letter-spacing: .35px;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .routeList{ display:grid; gap:10px; }
    .routeCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px 12px;
      display: grid;
      gap: 8px;
    }
    .routeTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .routeName{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 800;
      font-size: 13px;
    }
    .pillSmall{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: rgba(255,255,255,.88);
      white-space: nowrap;
    }
    .routeMeta{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      display: grid;
      gap: 2px;
    }
    .routeActions{ display:flex; gap:8px; flex-wrap: wrap; }

    .leaflet-control-zoom a{
      background: rgba(15,17,24,.78) !important;
      color: white !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .leaflet-control-attribution{
      background: rgba(15,17,24,.55) !important;
      color: rgba(255,255,255,.7) !important;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(var(--blur));
      margin: 0 10px 10px 0;
    }

    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: rgba(15,17,24,.95) !important;
      color: rgba(255,255,255,.92) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
    }
    .leaflet-popup-close-button { color: rgba(255,255,255,.88) !important; }
    .leaflet-popup-content { margin: 12px 14px !important; }

    .crimeBubble{
      border-radius: 999px;
      position: relative;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));
    }
    .crimeBubble::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      animation: pulse 1.6s ease-out infinite;
      opacity:.6;
      border: 2px solid currentColor;
    }
    @keyframes pulse{
      0%{ transform: scale(.75); opacity: .65; }
      100%{ transform: scale(1.35); opacity: 0; }
    }

    #toastWrap{
      position:fixed; left:12px; right:12px;
      top:calc(12px + var(--topPad));
      z-index:2000;
      display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,17,24,.92), rgba(15,17,24,.72));
      backdrop-filter: blur(16px);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      gap: 10px;
      animation: slideIn .18s ease-out;
    }
    @keyframes slideIn{
      from{ transform: translateY(-10px); opacity: .0; }
      to{ transform: translateY(0); opacity: 1; }
    }
    .toastDot{
      width: 10px; height: 10px; border-radius:999px;
      margin-top: 5px;
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .toastTitle{ font-weight: 700; font-size: 13px; margin:0; }
    .toastMeta{ font-size: 12px; color: rgba(255,255,255,.72); line-height:1.35; margin-top:2px; }
    .toastActions{ display:flex; gap:8px; margin-top:8px; flex-wrap: wrap; }
    .toastBtn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 8px 10px;
      border-radius: 14px;
    }
    .toastBtn:hover{ background: rgba(255,255,255,.10); }

    .drawerOverlay{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 1400;
    }
    .drawerOverlay.open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: absolute;
      top: calc(12px + var(--topPad));
      right: 12px;
      bottom: calc(12px + var(--botPad));
      width: 420px;
      max-width: calc(100% - 24px);
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,17,24,.94), rgba(15,17,24,.74));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      transform: translateX(110%);
      transition: transform .22s ease;
      z-index: 1500;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      will-change: transform;
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .drawerTitle{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .drawerTitle b{ font-size: 13px; }
    .drawerTitle span{ font-size: 12px; color: var(--muted); }

    .drawerBody{
      padding: 12px 14px 14px;
      overflow: auto;
      display: grid;
      gap: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .drawerControls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .seg{
      display:flex;
      gap: 6px;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .seg button{
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
    }
    .seg button.active{
      background: rgba(255,255,255,.12);
    }

    .eventCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px 12px;
      display: grid;
      gap: 8px;
    }
    .eventTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .eventType{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 700;
      font-size: 13px;
    }
    .sevPill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: rgba(255,255,255,.88);
      white-space: nowrap;
    }
    .eventMeta{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
    }
    .eventDesc{
      font-size: 12.5px;
      color: rgba(255,255,255,.86);
      line-height: 1.4;
    }
    .eventActions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .kbdHint{ font-size: 12px; color: var(--muted); }

    @media (max-width: 720px){
      .topbar{ flex-wrap: wrap; }
      .brand .sub{ display:none; }

      .drawer{
        left: 12px;
        right: 12px;
        width: auto;
        top: auto;
        bottom: calc(12px + var(--botPad));
        height: min(78vh, 680px);
        transform: translateY(110%);
      }
      .drawer.open{ transform: translateY(0); }
    }

    @media (min-width: 980px){
      .topbar{ left: 16px; right: 16px; flex-wrap: nowrap; }
      .sheet{ left: 16px; width: 460px; right: auto; }
      #toastWrap{ left: 16px; right: auto; width: 420px; }
      .drawer{ right: 16px; width: 420px; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <!-- Toasts -->
  <div id="toastWrap"></div>

  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-label="RU-SAFE logo">
        <svg viewBox="0 0 64 64" width="34" height="34" role="img" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(68,194,255,1)"/>
              <stop offset="0.55" stop-color="rgba(255,204,51,1)"/>
              <stop offset="1" stop-color="rgba(255,51,68,1)"/>
            </linearGradient>
          </defs>
          <path d="M32 6c8 7 16 9 22 10v18c0 14-9 22-22 26C19 56 10 48 10 34V16c6-1 14-3 22-10Z"
                fill="url(#g)" stroke="rgba(255,255,255,.35)" stroke-width="2" />
          <text x="32" y="40" text-anchor="middle" font-size="20" font-weight="800"
                fill="rgba(10,12,16,.90)" font-family="system-ui, -apple-system, Segoe UI, Roboto">RU</text>
        </svg>
      </div>

      <div style="min-width:0">
        <h1>RU-SAFE</h1>
        <div class="sub">CRIME HEAT BUBBLES</div>
      </div>
    </div>

    <div class="pill">
      <small>Status:</small>
      <span id="statusText">Loading…</span>
    </div>

    <div class="pill" style="margin-left:auto; gap:8px;">
      <button class="btn" id="recenterBtn" title="Recenter to Rutgers">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 2v3m0 14v3M2 12h3m14 0h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        Rutgers
      </button>

      <button class="btn" id="overviewBtn" title="Event overview">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"/>
        </svg>
        Overview
      </button>

      <button class="btn" id="toggleSheetBtn" title="Toggle controls panel">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Panel
      </button>
    </div>
  </div>

  <!-- Overview Drawer -->
  <div class="drawerOverlay" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Event overview drawer">
    <div class="drawerHeader">
      <div class="drawerTitle">
        <b>Event Overview</b>
        <span id="drawerSub">Past 7 days • 0 incidents</span>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <span class="kbdHint">Esc</span>
        <button class="btn" id="drawerCloseBtn" title="Close overview">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Close
        </button>
      </div>
    </div>

    <div class="drawerBody">
      <div class="drawerControls">
        <div class="seg" aria-label="Time range">
          <button id="range7" class="active" type="button">7d</button>
          <button id="range14" type="button">14d</button>
          <button id="range30" type="button">30d</button>
        </div>

        <select id="overviewMinSev" title="Minimum severity for overview" style="min-width: 170px;">
          <option value="1" selected>Min severity: 1+</option>
          <option value="2">Min severity: 2+</option>
          <option value="3">Min severity: 3+</option>
          <option value="4">Min severity: 4+</option>
          <option value="5">Min severity: 5</option>
        </select>
      </div>

      <div id="overviewList" style="display:grid; gap:10px;"></div>
    </div>
  </aside>

  <!-- Bottom sheet -->
  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader">
      <div style="flex:1;">
        <div class="grab"></div>
        <div class="sheetTitle">
          <b>Live controls</b>
          <span><span id="countText">0</span> incidents • Updated <span id="updatedText">—</span></span>
        </div>
      </div>
      <button class="btn" id="refreshBtn" title="Refresh now">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 12a8 8 0 1 1-2.34-5.66M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Refresh
      </button>
    </div>

    <div class="sheetBody">
      <div class="row">
        <div class="control">
          <select id="minSeverity" title="Minimum severity">
            <option value="1" selected>Min severity: 1+</option>
            <option value="2">Min severity: 2+</option>
            <option value="3">Min severity: 3+</option>
            <option value="4">Min severity: 4+</option>
            <option value="5">Min severity: 5</option>
          </select>

          <input id="minutesWindow" type="number" min="15" step="15" value="240" title="Show incidents from last N minutes" inputmode="numeric" />
        </div>
      </div>

      <div class="legend">
        <div class="chip"><span class="dot" style="background:var(--low)"></span>1–2 Low</div>
        <div class="chip"><span class="dot" style="background:var(--med)"></span>3 Medium</div>
        <div class="chip"><span class="dot" style="background:var(--high)"></span>4 High</div>
        <div class="chip"><span class="dot" style="background:var(--crit)"></span>5 Critical</div>
      </div>

      <div class="tip">
        Data source: <b>/api/incidents</b> (server proxy → Google Sheets).<br/>
        Headers must be: <b>severity, crime_type, location, time, description, latitude, longitude</b>
      </div>

      <div class="sectionTitle">Safety Route</div>

      <div class="row" style="justify-content:flex-start;">
        <div class="control">
          <button class="btn tiny" id="setStartBtn" title="Tap then click the map to set Start">Set Start</button>
          <button class="btn tiny" id="setDestBtn" title="Tap then click the map to set Destination">Set Destination</button>
          <button class="btn tiny danger" id="clearRouteBtn" title="Clear routing markers and routes">Clear</button>
          <button class="btn tiny primary" id="computeRouteBtn" title="Compute walking routes + alternatives">Compute Routes</button>
        </div>
      </div>

      <div class="row" style="justify-content:flex-start;">
        <div class="control">
          <select id="riskDays" title="How far back to consider incidents for risk" style="min-width: 170px;">
            <option value="1">Risk window: 1 day</option>
            <option value="3">Risk window: 3 days</option>
            <option value="7" selected>Risk window: 7 days</option>
            <option value="14">Risk window: 14 days</option>
          </select>

          <select id="riskMinSev" title="Minimum severity for risk scoring" style="min-width: 180px;">
            <option value="1">Risk min severity: 1+</option>
            <option value="2">Risk min severity: 2+</option>
            <option value="3" selected>Risk min severity: 3+</option>
            <option value="4">Risk min severity: 4+</option>
            <option value="5">Risk min severity: 5</option>
          </select>
        </div>
      </div>

      <div class="tip" id="routeHint">
        Tap <b>Set Start</b> then tap the map. Do the same for <b>Set Destination</b>, then press <b>Compute Routes</b>.
      </div>

      <div id="routeResults" class="routeList"></div>
    </div>
  </div>
</div>

<script>
/********************************************************************
 * RU-SAFE — Starts zoomed to Rutgers, but NOT restricted.
 * - No max bounds
 * - No fitBounds
 * - No minZoom lock
 ********************************************************************/

const SHEETS_URL = "/api/incidents";
const REFRESH_MS = 15000;
const OSRM_BASE = "https://router.project-osrm.org/route/v1/foot";

const MAX_GROWTH_MINUTES = 30;

// ✅ Start focused on Rutgers, but allow free pan/zoom anywhere
const DEFAULT_CENTER = [40.5009, -74.4474];
const DEFAULT_ZOOM = 15;

// Optional URL start override: ?lat=..&lng=..&z=..
function getUrlNumber(key){
  const v = new URLSearchParams(location.search).get(key);
  if (v === null) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
const startLat = getUrlNumber("lat");
const startLng = getUrlNumber("lng");
const startZ   = getUrlNumber("z");

// ---------- helpers ----------
function getCss(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function sevColor(sev){
  const s = Number(sev);
  if (s >= 5) return getCss("--crit");
  if (s >= 4) return getCss("--high");
  if (s >= 3) return getCss("--med");
  return getCss("--low");
}
function sevLabel(sev){
  const s = Number(sev);
  if (s >= 5) return "Critical";
  if (s >= 4) return "High";
  if (s >= 3) return "Medium";
  return "Low";
}

// Smaller circles so they fit better
function sevRadiusMeters(sev){
  const s = Number(sev);
  if (s >= 5) return 42;
  if (s >= 4) return 36;
  if (s >= 3) return 30;
  if (s >= 2) return 24;
  return 20;
}

function parseTime(value){
  if (value === null || value === undefined) return null;
  if (value instanceof Date && !isNaN(value.getTime())) return value;

  const s = String(value).trim();
  if (!s) return null;

  if (/^\d+(\.\d+)?$/.test(s)) {
    const serial = Number(s);
    if (serial > 30000) {
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = serial * 86400 * 1000;
      const d = new Date(epoch.getTime() + ms);
      if (!isNaN(d.getTime())) return d;
    }
  }

  let d = new Date(s);
  if (!isNaN(d.getTime())) return d;

  if (/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(s)){
    d = new Date(s.replace(" ", "T"));
    if (!isNaN(d.getTime())) return d;
  }

  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?(?:\s*(AM|PM))?$/i);
  if (m) {
    let mm = Number(m[1]);
    let dd = Number(m[2]);
    let yy = Number(m[3]);
    let hh = Number(m[4] ?? 0);
    let mi = Number(m[5] ?? 0);
    let ss = Number(m[6] ?? 0);
    const ampm = (m[7] ?? "").toUpperCase();

    if (ampm === "PM" && hh < 12) hh += 12;
    if (ampm === "AM" && hh === 12) hh = 0;

    d = new Date(yy, mm - 1, dd, hh, mi, ss);
    if (!isNaN(d.getTime())) return d;
  }

  return null;
}
function ageOpacityFactor(minutesOld, windowMinutes){
  const t = Math.max(0, Math.min(1, 1 - (minutesOld / windowMinutes)));
  return 0.20 + 0.80 * (t*t);
}
function fmtDistance(meters){
  const m = Number(meters) || 0;
  if (m >= 1000) return `${(m/1000).toFixed(2)} km`;
  return `${Math.round(m)} m`;
}
function fmtDuration(seconds){
  const s = Math.max(0, Math.round(Number(seconds) || 0));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

// Haversine (meters)
function haversineMeters(aLat, aLng, bLat, bLng){
  const R = 6371000;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(bLat - aLat);
  const dLng = toRad(bLng - aLng);
  const s1 = Math.sin(dLat/2);
  const s2 = Math.sin(dLng/2);
  const aa = s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
  const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
  return R * c;
}

// Route sampling
function samplePolyline(coords, stepMeters = 30, maxSamples = 550){
  if (!coords || coords.length < 2) return coords || [];
  const samples = [];
  let carry = 0;
  samples.push(coords[0]);

  for (let i=1; i<coords.length; i++){
    const prev = coords[i-1];
    const cur = coords[i];
    const segLen = haversineMeters(prev[1], prev[0], cur[1], cur[0]); // [lng,lat]
    let dist = carry + segLen;

    if (dist < stepMeters){
      carry = dist;
      continue;
    }

    const n = Math.floor(dist / stepMeters);
    for (let k=1; k<=n; k++){
      const t = (k*stepMeters - carry) / segLen;
      const clamped = Math.max(0, Math.min(1, t));
      const lng = prev[0] + (cur[0]-prev[0]) * clamped;
      const lat = prev[1] + (cur[1]-prev[1]) * clamped;
      samples.push([lng, lat]);
      if (samples.length >= maxSamples) return samples;
    }

    carry = dist - n * stepMeters;
  }
  return samples;
}

// ---------- UI refs ----------
const statusText = document.getElementById("statusText");
const countText = document.getElementById("countText");
const updatedText = document.getElementById("updatedText");
const refreshBtn = document.getElementById("refreshBtn");
const recenterBtn = document.getElementById("recenterBtn");
const toggleSheetBtn = document.getElementById("toggleSheetBtn");
const sheet = document.getElementById("sheet");
const sheetHeader = document.getElementById("sheetHeader");
const minSeveritySel = document.getElementById("minSeverity");
const minutesWindowInp = document.getElementById("minutesWindow");
const toastWrap = document.getElementById("toastWrap");

// Overview drawer refs
const overviewBtn = document.getElementById("overviewBtn");
const drawer = document.getElementById("drawer");
const drawerOverlay = document.getElementById("drawerOverlay");
const drawerCloseBtn = document.getElementById("drawerCloseBtn");
const drawerSub = document.getElementById("drawerSub");
const overviewList = document.getElementById("overviewList");
const overviewMinSev = document.getElementById("overviewMinSev");
const range7 = document.getElementById("range7");
const range14 = document.getElementById("range14");
const range30 = document.getElementById("range30");

// Safety Route refs
const setStartBtn = document.getElementById("setStartBtn");
const setDestBtn = document.getElementById("setDestBtn");
const clearRouteBtn = document.getElementById("clearRouteBtn");
const computeRouteBtn = document.getElementById("computeRouteBtn");
const riskDaysSel = document.getElementById("riskDays");
const riskMinSevSel = document.getElementById("riskMinSev");
const routeHint = document.getElementById("routeHint");
const routeResults = document.getElementById("routeResults");

// ---------- Map (NOT restricted) ----------
const initialCenter =
  (startLat !== null && startLng !== null) ? [startLat, startLng] : DEFAULT_CENTER;
const initialZoom = (startZ !== null) ? startZ : DEFAULT_ZOOM;

const map = L.map("map", { zoomControl: true }).setView(initialCenter, initialZoom);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  attribution: '&copy; OpenStreetMap &copy; CARTO',
  maxZoom: 20
}).addTo(map);

let bubbleLayer = L.layerGroup().addTo(map);

// ---------- Data state ----------
let rawIncidents = [];
const idToCircle = new Map();

// ---------- Live alert state ----------
const seenIds = new Set();
let hasInitializedSeenSet = false;

function incidentId(inc){
  return [
    String(inc.time ?? ""),
    String(inc.latitude ?? ""),
    String(inc.longitude ?? ""),
    String(inc.crime_type ?? ""),
    String(inc.severity ?? ""),
    String(inc.location ?? "")
  ].join("|");
}

function showToast(inc){
  const color = sevColor(inc.severity);

  const div = document.createElement("div");
  div.className = "toast";
  div.innerHTML = `
    <div class="toastDot" style="background:${color}"></div>
    <div style="flex:1;">
      <div class="toastTitle">NEW: ${escapeHtml(inc.crime_type || "Incident")} (Severity ${inc.severity}/5)</div>
      <div class="toastMeta">
        ${escapeHtml(inc.location || "Unknown location")}<br/>
        ${escapeHtml(String(inc.time || ""))}
      </div>
      <div class="toastActions">
        <button class="toastBtn" data-action="view">View on map</button>
        <button class="toastBtn" data-action="dismiss">Dismiss</button>
      </div>
    </div>
  `;

  div.querySelector('[data-action="view"]').addEventListener("click", () => {
    const lat = Number(inc.latitude);
    const lng = Number(inc.longitude);
    if (Number.isFinite(lat) && Number.isFinite(lng)){
      map.setView([lat, lng], Math.max(map.getZoom(), 16), { animate: true });
    }
    div.remove();
  });

  div.querySelector('[data-action="dismiss"]').addEventListener("click", () => div.remove());

  toastWrap.prepend(div);
  setTimeout(() => div.remove(), 10000);
}

// ---------- Fetch ----------
async function fetchIncidents(){
  statusText.textContent = "Fetching…";

  try{
    const res = await fetch(SHEETS_URL, { cache: "no-store" });
    const text = await res.text();

    if (!res.ok){
      throw new Error(`HTTP ${res.status} — ${text.slice(0,180)}`);
    }

    const json = JSON.parse(text);
    const values = json.values || [];

    if (values.length < 2){
      rawIncidents = [];
      statusText.textContent = "Live (0)";
      render();
      renderOverview();
      return;
    }

    const headers = values[0].map(h => String(h).trim().toLowerCase());
    const idx = (name) => headers.indexOf(name);

    const incoming = values.slice(1).map(r => ({
      severity: Number(r[idx("severity")]),
      crime_type: String(r[idx("crime_type")] ?? "Incident"),
      location: String(r[idx("location")] ?? ""),
      time: r[idx("time")] ?? "",
      description: String(r[idx("description")] ?? ""),
      latitude: Number(r[idx("latitude")]),
      longitude: Number(r[idx("longitude")]),
    })).filter(x =>
      Number.isFinite(x.latitude) &&
      Number.isFinite(x.longitude) &&
      Number.isFinite(x.severity)
    );

    const newOnes = [];
    for (const inc of incoming){
      const id = incidentId(inc);
      if (!seenIds.has(id)){
        if (hasInitializedSeenSet) newOnes.push(inc);
        seenIds.add(id);
      }
    }
    if (!hasInitializedSeenSet) hasInitializedSeenSet = true;

    rawIncidents = incoming;
    statusText.textContent = `Live (${incoming.length})`;

    newOnes.slice().reverse().forEach(showToast);
  }catch(err){
    console.error(err);
    statusText.textContent = `Offline: ${err.message || "Failed"}`;
    rawIncidents = [];
  }

  render();
  renderOverview();
  refreshRouteRiskOnly();
}

// ---------- Bubble helpers ----------
function addEscapeGradient(lat, lng, color, baseRadiusMeters){
  const multipliers = [1.0, 1.4, 1.9];
  const opacities   = [0.20, 0.10, 0.05];
  const weights     = [2, 1.5, 1];

  multipliers.forEach((m, i) => {
    const r = baseRadiusMeters * m;
    L.circle([lat, lng], {
      radius: r,
      color: color,
      weight: weights[i],
      opacity: 0.25,
      fillColor: color,
      fillOpacity: opacities[i],
      interactive: false
    }).addTo(bubbleLayer);
  });
}

// ---------- Render map ----------
function render(){
  const minSev = Number(minSeveritySel.value);
  const windowMinutes = Number(minutesWindowInp.value || 240);
  const now = new Date();

  const filtered = rawIncidents
    .map(x => ({ ...x, date: parseTime(x.time) }))
    .filter(x => x.date && !isNaN(x.date.getTime()))
    .filter(x => x.severity >= minSev)
    .filter(x => {
      const minutesOld = (now - x.date) / 60000;
      return minutesOld >= 0 && minutesOld <= windowMinutes;
    })
    .sort((a,b) => b.date - a.date);

  const smallScreen = window.matchMedia("(max-width: 720px)").matches;
  const heavy = filtered.length > 80;
  const perfDisableRings = smallScreen && heavy;
  const perfDisablePulse = smallScreen && heavy;

  bubbleLayer.clearLayers();
  idToCircle.clear();

  filtered.forEach((inc) => {
    const minutesOld = (now - inc.date) / 60000;
    const fade = ageOpacityFactor(minutesOld, windowMinutes);
    const color = sevColor(inc.severity);
    const radius = sevRadiusMeters(inc.severity);

    if (!perfDisableRings){
      const speedMetersPerMin = 12;
      const growthMinutes = Math.min(minutesOld, MAX_GROWTH_MINUTES);
      const extra = Math.min(120, growthMinutes * speedMetersPerMin);
      const gradientRadius = radius + extra;
      addEscapeGradient(inc.latitude, inc.longitude, color, gradientRadius);
    }

    const circle = L.circle([inc.latitude, inc.longitude], {
      radius,
      color,
      weight: 2,
      opacity: Math.min(1, 0.75 * fade + 0.15),
      fillColor: color,
      fillOpacity: Math.min(1, 0.30 * fade + 0.08)
    });

    const when = inc.date.toLocaleString([], { month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    const ago = `${Math.round(minutesOld)} min ago`;

    circle.bindPopup(`
      <div style="min-width:260px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
          <div style="width:10px;height:10px;border-radius:999px;background:${color};box-shadow:0 0 0 4px rgba(255,255,255,.06)"></div>
          <b style="font-size:14px">${escapeHtml(inc.crime_type)}</b>
        </div>

        <div style="font-size:12.5px;line-height:1.45;color:rgba(255,255,255,.86)">
          <div><b>Severity:</b> ${inc.severity}/5</div>
          <div><b>Location:</b> ${escapeHtml(inc.location || "—")}</div>
          <div><b>Time:</b> ${when} (${ago})</div>

          <div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.12)">
            <b>Description:</b><br/>
            ${escapeHtml(inc.description || "No additional details provided.")}
          </div>
        </div>
      </div>
    `);

    circle.addTo(bubbleLayer);

    // Center dot is centered correctly
    if (!perfDisablePulse){
      const basePx = 10 + (Number(inc.severity) * 2);
      const size = Math.max(10, Math.min(20, basePx));

      const pulse = L.marker([inc.latitude, inc.longitude], {
        icon: L.divIcon({
          className: "crimeBubble",
          html: `<div style="
            width:${size}px;
            height:${size}px;
            background:${color};
            opacity:${Math.min(1, 0.70 * fade + 0.15)};
            color:${color};
            border:1px solid rgba(255,255,255,.22);
            border-radius:999px;
          "></div>`,
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        }),
        interactive: false
      });
      pulse.addTo(bubbleLayer);
    }

    idToCircle.set(incidentId(inc), circle);
  });

  countText.textContent = String(filtered.length);
  updatedText.textContent = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
}

// ---------- Overview ----------
let overviewDays = 7;

function setActiveRangeButton(days){
  overviewDays = days;
  [range7, range14, range30].forEach(b => b.classList.remove("active"));
  if (days === 7) range7.classList.add("active");
  else if (days === 14) range14.classList.add("active");
  else range30.classList.add("active");
  renderOverview();
}
function openDrawer(){
  drawer.classList.add("open");
  drawerOverlay.classList.add("open");
  drawerOverlay.setAttribute("aria-hidden", "false");
  renderOverview();
}
function closeDrawer(){
  drawer.classList.remove("open");
  drawerOverlay.classList.remove("open");
  drawerOverlay.setAttribute("aria-hidden", "true");
}
function summarizeShort(desc){
  const s = String(desc ?? "").trim();
  if (!s) return "No description provided.";
  return s.length > 120 ? s.slice(0, 117) + "…" : s;
}
function renderOverview(){
  const now = new Date();
  const minSev = Number(overviewMinSev.value || 1);
  const cutoff = new Date(now.getTime() - overviewDays * 24 * 60 * 60 * 1000);

  const list = rawIncidents
    .map(x => ({ ...x, date: parseTime(x.time) }))
    .filter(x => x.date && !isNaN(x.date.getTime()))
    .filter(x => x.date >= cutoff && x.date <= now)
    .filter(x => x.severity >= minSev)
    .sort((a,b) => b.date - a.date);

  drawerSub.textContent = `Past ${overviewDays} days • ${list.length} incidents`;

  if (list.length === 0){
    overviewList.innerHTML = `
      <div class="eventCard">
        <div class="eventDesc">No incidents match your filters for the past ${overviewDays} days.</div>
        <div class="eventMeta">Try lowering “Min severity” or switching to 14d/30d.</div>
      </div>
    `;
    return;
  }

  overviewList.innerHTML = "";

  list.forEach((inc) => {
    const id = incidentId(inc);
    const color = sevColor(inc.severity);

    const when = inc.date.toLocaleString([], {
      weekday: "short",
      month:"short",
      day:"2-digit",
      hour:"2-digit",
      minute:"2-digit"
    });

    const card = document.createElement("div");
    card.className = "eventCard";
    card.innerHTML = `
      <div class="eventTop">
        <div>
          <div class="eventType">
            <span style="width:10px;height:10px;border-radius:999px;background:${color};box-shadow:0 0 0 4px rgba(255,255,255,.06);display:inline-block;"></span>
            ${escapeHtml(inc.crime_type || "Incident")}
          </div>
          <div class="eventMeta">
            <div><b>Time:</b> ${escapeHtml(when)}</div>
            <div><b>Location:</b> ${escapeHtml(inc.location || "—")}</div>
          </div>
        </div>

        <div class="sevPill" title="Severity">
          <span style="width:8px;height:8px;border-radius:999px;background:${color};display:inline-block;"></span>
          ${inc.severity}/5 ${sevLabel(inc.severity)}
        </div>
      </div>

      <div class="eventDesc">${escapeHtml(summarizeShort(inc.description))}</div>

      <div class="eventActions">
        <button class="toastBtn" data-act="jump">Jump</button>
        <button class="toastBtn" data-act="open">Open popup</button>
      </div>
    `;

    const lat = Number(inc.latitude);
    const lng = Number(inc.longitude);

    const jump = () => {
      if (Number.isFinite(lat) && Number.isFinite(lng)){
        map.setView([lat, lng], Math.max(map.getZoom(), 16), { animate: true });
      }
    };

    card.querySelector('[data-act="jump"]').addEventListener("click", () => jump());
    card.querySelector('[data-act="open"]').addEventListener("click", () => {
      jump();
      const circle = idToCircle.get(id);
      if (circle) circle.openPopup();
      else showToast(inc);
    });

    overviewList.appendChild(card);
  });
}

// Drawer events
overviewBtn.addEventListener("click", () => {
  const isOpen = drawer.classList.contains("open");
  if (isOpen) closeDrawer();
  else openDrawer();
});
drawerCloseBtn.addEventListener("click", closeDrawer);
drawerOverlay.addEventListener("click", closeDrawer);
window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDrawer(); });

// Range buttons
range7.addEventListener("click", () => setActiveRangeButton(7));
range14.addEventListener("click", () => setActiveRangeButton(14));
range30.addEventListener("click", () => setActiveRangeButton(30));
overviewMinSev.addEventListener("change", renderOverview);

// ---------- 2-state drag sheet (OPEN / CLOSED) ----------
let sheetSnap = { open: 0, closed: 0 };
let sheetState = "closed";
let drag = { startY: null, startOffset: 0, currentOffset: 0 };

function computeSheetSnap(){
  const h = sheet.getBoundingClientRect().height;
  const headerH = sheetHeader.getBoundingClientRect().height || 78;

  const open = 0;
  const peek = Math.max(62, Math.min(78, headerH));
  const closed = Math.max(0, h - peek);

  sheetSnap = { open, closed };
  setSheetState(sheetState, false);
}
function setSheetOffset(px, animate=true){
  drag.currentOffset = px;
  sheet.style.setProperty("--sheetY", `${px}px`);
  sheet.style.transition = animate ? "transform .22s ease" : "none";
}
function setSheetState(state, animate=true){
  sheetState = state;
  setSheetOffset(state === "open" ? sheetSnap.open : sheetSnap.closed, animate);
  setTimeout(() => map.invalidateSize(), 240);
}
function toggleSheet(){
  setSheetState(sheetState === "closed" ? "open" : "closed");
}

window.addEventListener("load", () => {
  computeSheetSnap();
  setSheetState("closed");
});
window.addEventListener("resize", () => { computeSheetSnap(); render(); renderOverview(); });

sheetHeader.addEventListener("pointerdown", (e) => {
  computeSheetSnap();
  drag.startY = e.clientY;
  drag.startOffset = drag.currentOffset;
  sheet.style.transition = "none";
  sheetHeader.setPointerCapture(e.pointerId);
});
sheetHeader.addEventListener("pointermove", (e) => {
  if (drag.startY === null) return;
  const dy = e.clientY - drag.startY;
  const next = Math.min(sheetSnap.closed, Math.max(sheetSnap.open, drag.startOffset + dy));
  setSheetOffset(next, false);
});
sheetHeader.addEventListener("pointerup", () => {
  if (drag.startY === null) return;
  drag.startY = null;

  const cur = drag.currentOffset;
  const distToOpen = Math.abs(cur - sheetSnap.open);
  const distToClosed = Math.abs(cur - sheetSnap.closed);
  setSheetState(distToOpen <= distToClosed ? "open" : "closed");
});

// Panel toggle button: ONLY open/closed
toggleSheetBtn.addEventListener("click", toggleSheet);

// ---------- Buttons ----------
refreshBtn.addEventListener("click", fetchIncidents);
minSeveritySel.addEventListener("change", () => { render(); renderOverview(); refreshRouteRiskOnly(); });
minutesWindowInp.addEventListener("change", () => { render(); renderOverview(); refreshRouteRiskOnly(); });

// Recenter always returns to Rutgers start view
recenterBtn.addEventListener("click", () => {
  map.setView(DEFAULT_CENTER, DEFAULT_ZOOM, { animate: true });
});

// ===================== SAFETY ROUTE MODE =====================
let routingMode = null; // "start" | "dest" | null
let startMarker = null;
let destMarker = null;
let routeLayerGroup = L.layerGroup().addTo(map);
let currentRoutes = [];
let selectedRouteIndex = 0;

function setRoutingMode(mode){
  routingMode = mode;
  setStartBtn.classList.toggle("active", mode === "start");
  setDestBtn.classList.toggle("active", mode === "dest");

  if (mode === "start") routeHint.innerHTML = `Tap the map to set <b>Start</b>.`;
  else if (mode === "dest") routeHint.innerHTML = `Tap the map to set <b>Destination</b>.`;
  else routeHint.innerHTML = `Tap <b>Set Start</b> then tap the map. Do the same for <b>Set Destination</b>, then press <b>Compute Routes</b>.`;
}

function ensureMarker(which, latlng){
  const icon = L.divIcon({
    className: "",
    html: `<div style="
      width:14px;height:14px;border-radius:999px;
      background:${which==="start" ? "rgba(68,194,255,.95)" : "rgba(255,204,51,.95)"};
      border:2px solid rgba(255,255,255,.90);
      box-shadow: 0 10px 22px rgba(0,0,0,.55);
    "></div>`,
    iconSize: [14,14],
    iconAnchor: [7,7]
  });

  if (which === "start"){
    if (startMarker) startMarker.setLatLng(latlng);
    else startMarker = L.marker(latlng, { icon }).addTo(routeLayerGroup).bindPopup("Start");
  } else {
    if (destMarker) destMarker.setLatLng(latlng);
    else destMarker = L.marker(latlng, { icon }).addTo(routeLayerGroup).bindPopup("Destination");
  }
}

function clearRoutes(){
  currentRoutes = [];
  selectedRouteIndex = 0;
  routeResults.innerHTML = "";
  routeLayerGroup.clearLayers();
  startMarker = null;
  destMarker = null;
  setRoutingMode(null);
}

function drawRoutes(){
  routeLayerGroup.clearLayers();

  if (startMarker) startMarker.addTo(routeLayerGroup);
  if (destMarker) destMarker.addTo(routeLayerGroup);

  currentRoutes.forEach((r, idx) => {
    const isSel = idx === selectedRouteIndex;
    const weight = isSel ? 6 : 4;
    const opacity = isSel ? 0.95 : 0.45;
    const color = isSel ? getCss("--low") : "rgba(255,255,255,.55)";

    const line = L.geoJSON(r.geojson, { style: { color, weight, opacity } }).addTo(routeLayerGroup);
    r._layer = line;
  });
}

function zoomToRoute(idx){
  const r = currentRoutes[idx];
  if (!r || !r.geojson) return;
  const b = L.geoJSON(r.geojson).getBounds();
  if (b && b.isValid()) map.fitBounds(b.pad(0.18), { animate: true });
}

function riskBadge(risk){
  if (risk < 20) return { label: "Low risk", color: "rgba(68,194,255,.90)" };
  if (risk < 45) return { label: "Medium risk", color: "rgba(255,204,51,.90)" };
  if (risk < 80) return { label: "High risk", color: "rgba(255,122,24,.92)" };
  return { label: "Very high", color: "rgba(255,51,68,.92)" };
}

function filteredIncidentsForRisk(){
  const now = new Date();
  const days = Number(riskDaysSel.value || 7);
  const minSev = Number(riskMinSevSel.value || 3);
  const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

  return rawIncidents
    .map(x => ({ ...x, date: parseTime(x.time) }))
    .filter(x => x.date && !isNaN(x.date.getTime()))
    .filter(x => x.date >= cutoff && x.date <= now)
    .filter(x => x.severity >= minSev);
}

function computeRouteRisk(coordsLngLat){
  const incidents = filteredIncidentsForRisk();
  if (!coordsLngLat || coordsLngLat.length < 2) return 0;
  if (incidents.length === 0) return 0;

  const samples = samplePolyline(coordsLngLat, 30, 550);
  const now = new Date();

  const RADIUS_M = 180;
  let score = 0;

  for (const p of samples){
    const lng = p[0], lat = p[1];

    for (const inc of incidents){
      const d = haversineMeters(lat, lng, inc.latitude, inc.longitude);
      if (d > RADIUS_M) continue;

      const sev = Number(inc.severity) || 1;
      const ageHrs = Math.max(0, (now - inc.date) / 3600000);

      const rec = 1 / (1 + ageHrs / 24);
      const distW = 1 - (d / RADIUS_M);
      const sevW = Math.pow(sev, 1.35);

      score += sevW * rec * distW;
    }
  }

  const norm = score / Math.max(1, samples.length) * 18;
  return Math.round(norm * 10) / 10;
}

function renderRouteResults(){
  if (!startMarker || !destMarker || currentRoutes.length === 0){
    routeResults.innerHTML = "";
    return;
  }

  const safestIdx = currentRoutes.reduce((best, r, i) => r.risk < currentRoutes[best].risk ? i : best, 0);
  const fastestIdx = currentRoutes.reduce((best, r, i) => r.duration < currentRoutes[best].duration ? i : best, 0);

  routeResults.innerHTML = "";

  currentRoutes.forEach((r, idx) => {
    const badge = riskBadge(r.risk);
    const isSel = idx === selectedRouteIndex;

    const tag =
      idx === safestIdx ? "Safest" :
      idx === fastestIdx ? "Fastest" :
      "Alternate";

    const card = document.createElement("div");
    card.className = "routeCard";
    card.innerHTML = `
      <div class="routeTop">
        <div>
          <div class="routeName">
            <span style="width:10px;height:10px;border-radius:999px;background:${isSel ? getCss("--low") : "rgba(255,255,255,.35)"};box-shadow:0 0 0 4px rgba(255,255,255,.06);display:inline-block;"></span>
            Route ${idx + 1} • ${escapeHtml(tag)}
          </div>
          <div class="routeMeta">
            <div><b>ETA:</b> ${escapeHtml(fmtDuration(r.duration))} • <b>Distance:</b> ${escapeHtml(fmtDistance(r.distance))}</div>
            <div><b>Risk score:</b> ${escapeHtml(String(r.risk))} <span style="color:${badge.color}">(${escapeHtml(badge.label)})</span></div>
          </div>
        </div>
        <div class="pillSmall">${isSel ? "Selected" : "Select"}</div>
      </div>

      <div class="routeActions">
        <button class="toastBtn" data-act="select">Select</button>
        <button class="toastBtn" data-act="zoom">Zoom</button>
      </div>
    `;

    card.querySelector('[data-act="select"]').addEventListener("click", () => {
      selectedRouteIndex = idx;
      drawRoutes();
      renderRouteResults();
    });
    card.querySelector('[data-act="zoom"]').addEventListener("click", () => zoomToRoute(idx));

    card.addEventListener("click", (e) => {
      if (e.target && e.target.closest("button")) return;
      selectedRouteIndex = idx;
      drawRoutes();
      renderRouteResults();
    });

    routeResults.appendChild(card);
  });
}

async function computeRoutes(){
  if (!startMarker || !destMarker){
    routeHint.innerHTML = `Set <b>Start</b> and <b>Destination</b> first.`;
    return;
  }

  const s = startMarker.getLatLng();
  const d = destMarker.getLatLng();

  const url =
    `${OSRM_BASE}/${s.lng},${s.lat};${d.lng},${d.lat}` +
    `?alternatives=true&overview=full&geometries=geojson&steps=false`;

  computeRouteBtn.classList.add("active");
  computeRouteBtn.textContent = "Computing…";

  try{
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok){
      const txt = await res.text().catch(() => "");
      throw new Error(`Routing HTTP ${res.status}: ${txt.slice(0,160)}`);
    }
    const json = await res.json();

    if (!json.routes || json.routes.length === 0){
      throw new Error("No routes returned (try different points).");
    }

    currentRoutes = json.routes.slice(0, 3).map((r) => {
      const coords = r.geometry?.coordinates || [];
      const risk = computeRouteRisk(coords);
      return {
        distance: r.distance,
        duration: r.duration,
        coords,
        risk,
        geojson: { type: "Feature", properties: {}, geometry: r.geometry }
      };
    });

    selectedRouteIndex = currentRoutes.reduce((best, r, i) => r.risk < currentRoutes[best].risk ? i : best, 0);

    drawRoutes();
    renderRouteResults();
    zoomToRoute(selectedRouteIndex);

    routeHint.innerHTML = `Showing <b>${currentRoutes.length}</b> routes. Risk uses last <b>${escapeHtml(riskDaysSel.value)}</b> days (min severity <b>${escapeHtml(riskMinSevSel.value)}</b>).`;
  }catch(err){
    console.error(err);
    routeHint.innerHTML = `<span style="color:rgba(255,204,51,.92)"><b>Routing failed:</b> ${escapeHtml(err.message || "Unknown error")}</span>`;
  }finally{
    computeRouteBtn.classList.remove("active");
    computeRouteBtn.textContent = "Compute Routes";
  }
}

function refreshRouteRiskOnly(){
  if (!currentRoutes || currentRoutes.length === 0) return;
  currentRoutes = currentRoutes.map(r => ({ ...r, risk: computeRouteRisk(r.coords) }));
  selectedRouteIndex = currentRoutes.reduce((best, r, i) => r.risk < currentRoutes[best].risk ? i : best, 0);
  drawRoutes();
  renderRouteResults();
}

// Map clicks for routing (no restriction)
map.on("click", (e) => {
  if (!routingMode) return;

  const latlng = e.latlng;

  if (routingMode === "start") ensureMarker("start", latlng);
  else ensureMarker("dest", latlng);

  setRoutingMode(null);

  if (startMarker && destMarker){
    routeHint.innerHTML = `Start + Destination set. Press <b>Compute Routes</b>.`;
  } else if (startMarker){
    routeHint.innerHTML = `Start set. Now tap <b>Set Destination</b>.`;
  } else if (destMarker){
    routeHint.innerHTML = `Destination set. Now tap <b>Set Start</b>.`;
  }

  currentRoutes = [];
  routeResults.innerHTML = "";
  drawRoutes();
});

setStartBtn.addEventListener("click", () => setRoutingMode(routingMode === "start" ? null : "start"));
setDestBtn.addEventListener("click", () => setRoutingMode(routingMode === "dest" ? null : "dest"));
clearRouteBtn.addEventListener("click", clearRoutes);
computeRouteBtn.addEventListener("click", computeRoutes);
riskDaysSel.addEventListener("change", refreshRouteRiskOnly);
riskMinSevSel.addEventListener("change", refreshRouteRiskOnly);

// ---------- Start ----------
fetchIncidents();
setInterval(fetchIncidents, REFRESH_MS);
</script>
</body>
</html>